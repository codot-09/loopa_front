<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Joylashuv qo'shish</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #011627;
            --accent: #3a86ff;
            --bg: #f8f9fa;
            --white: #ffffff;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); font-family: -apple-system, system-ui, sans-serif; color: var(--primary); height: 100vh; display: flex; flex-direction: column; }

        header {
            background: var(--white);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            z-index: 1000;
        }

        .back-btn { background: none; border: none; padding: 4px; cursor: pointer; }

        .container { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 20px; overflow-y: auto; }

        #map {
            width: 100%;
            height: 300px;
            border-radius: 20px;
            border: 1px solid var(--border);
            z-index: 1;
        }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.85rem; font-weight: 700; color: var(--text-muted); margin-left: 4px; }

        select {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--white);
            font-size: 1rem;
            outline: none;
            appearance: none;
        }

        .coords-info {
            background: #eef5ff;
            padding: 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--accent);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .submit-btn {
            background: var(--accent);
            color: var(--white);
            border: none;
            padding: 16px;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 700;
            margin-top: auto;
            transition: opacity 0.2s;
        }
        .submit-btn:disabled { opacity: 0.6; }
    </style>
</head>
<body>

    <header>
        <button class="back-btn" onclick="history.back()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <h2 style="font-size: 1.1rem; font-weight: 800;">Manzilni aniqlash</h2>
    </header>

    <div class="container">
        <div id="map"></div>

        <div class="coords-info">
            <span id="lat-val">Lat: 41.3111</span>
            <span id="lng-val">Lng: 69.2406</span>
        </div>

        <div class="form-group">
            <label>Viloyatni tanlang</label>
            <select id="region">
                <option value="Toshkent shahri">Toshkent shahri</option>
                <option value="Toshkent viloyati">Toshkent viloyati</option>
                <option value="Andijon">Andijon</option>
                <option value="Buxoro">Buxoro</option>
                <option value="Farg'ona">Farg'ona</option>
                <option value="Jizzax">Jizzax</option>
                <option value="Xorazm">Xorazm</option>
                <option value="Namangan">Namangan</option>
                <option value="Navoiy">Navoiy</option>
                <option value="Qashqadaryo">Qashqadaryo</option>
                <option value="Samarqand">Samarqand</option>
                <option value="Sirdaryo">Sirdaryo</option>
                <option value="Surxondaryo">Surxondaryo</option>
                <option value="Qoraqalpog'iston">Qoraqalpog'iston</option>
            </select>
        </div>

        <button id="saveBtn" class="submit-btn">Manzilni saqlash</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let currentPos = [41.3111, 69.2406];
        const map = L.map('map').setView(currentPos, 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let marker = L.marker(currentPos, { draggable: true }).addTo(map);

        function updateCoords(lat, lng) {
            currentPos = [lat, lng];
            document.getElementById('lat-val').innerText = `Lat: ${lat.toFixed(4)}`;
            document.getElementById('lng-val').innerText = `Lng: ${lng.toFixed(4)}`;
        }

        marker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            updateCoords(pos.lat, pos.lng);
        });

        map.on('click', function(e) {
            marker.setLatLng(e.latlng);
            updateCoords(e.latlng.lat, e.latlng.lng);
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                map.setView([latitude, longitude], 15);
                marker.setLatLng([latitude, longitude]);
                updateCoords(latitude, longitude);
            });
        }

        document.getElementById('saveBtn').onclick = async function() {
            const btn = this;
            const region = document.getElementById('region').value;
            const token = localStorage.getItem('token');

            btn.disabled = true;
            tg.HapticFeedback.impactOccurred('medium');

            try {
                const res = await fetch('https://api.loopa.buzz/api/location/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        lat: currentPos[0],
                        lng: currentPos[1],
                        region: region
                    })
                });

                if (res.ok) {
                    tg.showAlert("Manzil muvaffaqiyatli saqlandi!", () => history.back());
                } else {
                    tg.showAlert("Xatolik yuz berdi. Qaytadan urinib ko'ring.");
                }
            } catch (err) {
                tg.showAlert("Tarmoq xatosi.");
            } finally {
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>