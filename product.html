<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mahsulot tafsilotlari</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #011627;
            --accent: #3a86ff;
            --bg: #f8f9fa;
            --white: #ffffff;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #2ec4b6;
            --danger: #ff4d4d;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); font-family: -apple-system, system-ui, sans-serif; color: var(--primary); padding-bottom: 110px; }

        .swiper { width: 100%; height: 380px; background: #eee; position: relative; }
        .swiper-slide img { width: 100%; height: 100%; object-fit: cover; }
        
        .media-counter {
            position: absolute; bottom: 45px; right: 20px; z-index: 10;
            background: rgba(0,0,0,0.5); color: white; padding: 4px 12px;
            border-radius: 20px; font-size: 0.75rem; font-weight: 600; backdrop-filter: blur(4px);
        }

        .top-actions { 
            position: absolute; top: 20px; left: 0; right: 0; 
            padding: 0 20px; z-index: 100; 
            display: flex; justify-content: space-between; 
        }
        
        .circle-btn { 
            background: rgba(255,255,255,0.9); border: none; width: 42px; height: 42px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.12); cursor: pointer;
        }

        .fav-btn svg { fill: none; stroke: var(--primary); transition: 0.3s; }
        .fav-btn.active { pointer-events: none; }
        .fav-btn.active svg { fill: var(--danger); stroke: var(--danger); }

        .content { 
            margin-top: -30px; background: var(--bg); border-radius: 30px 30px 0 0; 
            position: relative; z-index: 5; padding: 24px 20px; display: flex; flex-direction: column; gap: 20px; 
        }

        .category-tag { color: var(--accent); font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.8px; }
        .product-title { font-size: 1.5rem; font-weight: 800; margin: 4px 0; }
        .price-box { display: flex; align-items: baseline; gap: 8px; }
        .price { font-size: 1.4rem; font-weight: 900; color: var(--accent); }
        .price-label { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }

        .card { background: var(--white); padding: 18px; border-radius: 20px; border: 1px solid var(--border); }
        .card-title { font-size: 0.95rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

        .stats-flex { display: flex; align-items: center; gap: 16px; }
        .progress-ring { position: relative; width: 64px; height: 64px; }
        .progress-ring svg { transform: rotate(-90deg); width: 64px; height: 64px; }
        .progress-ring circle { fill: none; stroke-width: 6; cx: 32; cy: 32; r: 28; }
        .ring-bg { stroke: #f1f5f9; }
        .ring-fill { stroke: var(--success); stroke-linecap: round; transition: 1s ease; }
        .percentage { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.85rem; }

        #map { height: 200px; width: 100%; border-radius: 16px; margin-top: 12px; z-index: 2; border: 1px solid var(--border); }

        .sticky-footer { 
            position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); 
            backdrop-filter: blur(10px); padding: 16px 20px 30px; display: grid; grid-template-columns: 1fr 1fr; 
            gap: 12px; z-index: 100; border-top: 1px solid var(--border);
        }

        .btn { border: none; padding: 14px; border-radius: 16px; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; text-decoration: none; }
        .btn-outline { background: var(--white); color: var(--primary); border: 2px solid var(--primary); }
        .btn-fill { background: var(--primary); color: var(--white); }

        .loader { position: fixed; inset: 0; background: var(--white); z-index: 2000; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    </style>
</head>
<body>

    <div id="loader" class="loader">Yuklanmoqda...</div>

    <div id="mainUI" style="display: none;">
        <div class="top-actions">
            <button class="circle-btn" onclick="history.back()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <button id="favBtn" class="circle-btn fav-btn" onclick="addFavourite()">
                <svg width="22" height="22" viewBox="0 0 24 24" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.84-8.84 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            </button>
        </div>

        <div class="swiper">
            <div class="swiper-wrapper" id="p-slider"></div>
            <div class="media-counter" id="m-counter" style="display:none">1/1</div>
            <div class="swiper-pagination"></div>
        </div>

        <div class="content">
            <section>
                <span class="category-tag" id="p-cat"></span>
                <h1 class="product-title" id="p-name"></h1>
                <div class="price-box">
                    <span class="price" id="p-price"></span>
                    <span class="price-label" id="p-type"></span>
                </div>
            </section>

            <div class="card">
                <div class="stats-flex">
                    <div class="progress-ring">
                        <svg><circle class="ring-bg"></circle><circle id="ringFill" class="ring-fill" stroke-dasharray="175.9" stroke-dashoffset="175.9"></circle></svg>
                        <div class="percentage" id="p-percent">0%</div>
                    </div>
                    <div>
                        <p style="font-weight: 700; font-size: 0.9rem;">Tavsiya etiladi</p>
                        <p style="font-size: 0.75rem; color: var(--text-muted);">Xaridorlar ijobiy fikri</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Ma'lumot</h3>
                <p id="p-desc" style="font-size: 0.9rem; line-height: 1.6; color: #334155;"></p>
            </div>

            <div class="card">
                <h3 class="card-title">Joylashuv va yetkazib berish</h3>
                <div style="display: flex; flex-direction: column; gap: 6px; font-size: 0.85rem;">
                    <span>üìç <b id="p-region"></b></span>
                    <span>üöö <span id="p-delivery"></span></span>
                </div>
                <div id="map"></div>
            </div>
        </div>

        <div class="sticky-footer">
            <button class="btn btn-outline" onclick="voteAction()">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                Ovoz berish
            </button>
            <a id="p-chat" href="#" class="btn btn-fill">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 1 1-7.6-13.6 8.5 8.5 0 0 1 4.6 1.3L22 3l-1.5 5.5z"></path></svg>
                Bog'lanish
            </a>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const productId = new URLSearchParams(window.location.search).get('id');
        const token = localStorage.getItem('token');

        const translate = {
            FIXED: "Aniq narx", NEGOTIABLE: "Kelishuv asosida",
            AVAILABLE: "Mavjud", REGIONAL: "Viloyat bo'ylab", NOT_AVAILABLE: "Mavjud emas",
            ELECTRONICS: "Elektronika", CLOTHES: "Kiyim-kechak", HOME: "Uy-ro'zg'or", BEAUTY: "Go'zallik",
            SPORT: "Sport", TOYS: "O'yinchoqlar", OTHER: "Boshqa"
        };

        async function init() {
            try {
                const res = await fetch(`https://api.loopa.buzz/api/products/${productId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const { data } = await res.json();

                const slider = document.getElementById('p-slider');
                data.medias.forEach(url => {
                    slider.innerHTML += `<div class="swiper-slide"><img src="${url}"></div>`;
                });

                if (data.medias.length > 1) {
                    const counter = document.getElementById('m-counter');
                    counter.style.display = 'block';
                    counter.innerText = `1/${data.medias.length}`;
                    
                    new Swiper('.swiper', { 
                        pagination: { el: '.swiper-pagination' },
                        on: {
                            slideChange: function () {
                                counter.innerText = `${this.activeIndex + 1}/${data.medias.length}`;
                            }
                        }
                    });
                } else {
                    new Swiper('.swiper', { pagination: { el: '.swiper-pagination' } });
                }

                document.getElementById('p-cat').innerText = translate[data.category] || data.category;
                document.getElementById('p-name').innerText = data.name;
                document.getElementById('p-price').innerText = Number(data.price).toLocaleString() + " so'm";
                document.getElementById('p-type').innerText = `(${translate[data.priceType] || data.priceType})`;
                document.getElementById('p-desc').innerText = data.description;
                document.getElementById('p-region').innerText = data.locationResponse.region;
                document.getElementById('p-delivery').innerText = translate[data.deliveryType] || data.deliveryType;
                document.getElementById('p-chat').href = `https://t.me/${data.sellerContact.replace('@','')}`;

                if(data.isFavourites) {
                    document.getElementById('favBtn').classList.add('active');
                }

                const pr = data.recommendedPrecent || 0;
                document.getElementById('p-percent').innerText = pr + "%";
                document.getElementById('ringFill').style.strokeDashoffset = 175.9 - (175.9 * pr / 100);

                document.getElementById('loader').style.display = 'none';
                document.getElementById('mainUI').style.display = 'block';

                const map = L.map('map', { zoomControl: false, dragging: !tg.isExpanded }).setView([data.locationResponse.lat, data.locationResponse.lng], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([data.locationResponse.lat, data.locationResponse.lng]).addTo(map);
            } catch (e) { tg.showAlert("Yuklashda xatolik"); }
        }

        async function addFavourite() {
            try {
                const res = await fetch(`https://api.loopa.buzz/api/favourite/add?productId=${productId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    document.getElementById('favBtn').classList.add('active');
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } catch(e) { tg.showAlert("Xatolik yuz berdi"); }
        }

        function voteAction() {
            tg.showConfirm("Ushbu mahsulotni tavsiya qilasizmi?", async (ok) => {
                const res = await fetch(`https://api.loopa.buzz/api/votes?productId=${productId}&recommended=${ok}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) { tg.HapticFeedback.notificationOccurred('success'); location.reload(); }
            });
        }

        tg.ready();
        tg.expand();
        init();
    </script>
</body>
</html>